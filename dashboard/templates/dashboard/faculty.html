{% extends 'dashboard/base.html' %}
{% load static %}
{% block title %}Faculty Details - ANURAG Engineering College{% endblock %}

{% block content %}
<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
    /* Global Matrix Styling to match Dashboard */
    body {
        margin: 0;
        padding: 0;
        font-family: 'Courier New', monospace;
        overflow-x: hidden;
        background-color: #000;
        color: #0f0;
    }

    #matrix-canvas {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
    }

    /* Horizontal Navigation Tabs */
    .nav-tabs-container {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 10px;
        background: rgba(0, 20, 0, 0.9);
        padding: 20px;
        border: 1px solid #0f0;
        width: 100%;
        max-width: 1200px;
        margin: 20px auto 40px auto;
        border-radius: 8px;
        box-shadow: 0 0 15px rgba(0, 255, 0, 0.2);
    }

    .nav-link-tab {
        padding: 12px 20px;
        color: #0f0;
        text-decoration: none;
        font-weight: bold;
        text-transform: uppercase;
        border: 1px solid #0f0;
        transition: 0.3s;
        font-size: 0.9rem;
    }

    .nav-link-tab:hover {
        background: #0f0;
        color: #000;
        box-shadow: 0 0 15px #0f0;
    }

    .nav-link-tab.active {
        background: rgba(0, 255, 0, 0.2);
        border-width: 2px;
    }

    /* Base Styles for the Form Container */
    .container {
        max-width: 1200px; margin: 20px auto 20px 20px;
        background: white; padding: 30px; border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08); margin-right: 320px;
        color: #333; /* Ensuring form text is readable on white */
    }

    h1 { color: #2c3e50; text-align: center; border-bottom: 3px solid #3498db; padding-bottom: 15px; margin-bottom: 30px; font-weight: 700; }
    h3 { color: #34495e; border-left: 5px solid #3498db; padding-left: 15px; margin-top: 40px; margin-bottom: 20px; font-size: 1.25rem; font-weight: 600; }

    /* Form Elements */
    .form-section { background: #fff; border: 1px solid #e0e0e0; padding: 25px; border-radius: 8px; margin-bottom: 25px; }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
    .form-label { font-weight: 600; font-size: 12px; color: #555; margin-bottom: 6px; display: block; text-transform: uppercase; letter-spacing: 0.5px; }
    input, select, textarea { width: 100%; padding: 10px 12px; border: 1px solid #dcdcdc; border-radius: 5px; font-size: 14px; box-sizing: border-box; }

    /* Grids */
    .achievements-grid, .scm-grid, .mem-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
    .pub-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
    .pub-full { grid-column: 1 / -1; }
    .pub-half { grid-column: span 2; }
    .date-row { display: flex; gap: 10px; }
    .upload-box { display: flex; align-items: center; gap: 10px; background: #f9f9f9; padding: 8px; border: 1px dashed #bdc3c7; border-radius: 5px; }

    /* Education */
    .edu-header { background: #eef7fb; color: #2980b9; font-weight: bold; padding: 8px 12px; border-radius: 4px; margin: 20px 0 10px; border-left: 4px solid #2980b9; }
    .edu-basics-row { display: grid; grid-template-columns: 60px 3fr 1fr 1fr 120px; gap: 10px; align-items: end; margin-bottom: 10px; }
    .edu-spec-row { display: grid; grid-template-columns: 60px 120px 2fr 1fr 1fr 120px; gap: 10px; align-items: end; margin-bottom: 10px; }

    /* Buttons */
    .add-btn, .mini-upload-btn { background: #e67e22; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 13px; text-align: center; }
    .mini-upload-btn { background: #3498db; width: 100%; padding: 9px; }
    .mini-upload-btn.uploaded { background: #27ae60; }
    .load-btn { background: #34495e; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; width: 100%; font-weight: bold; height: 42px; }

    /* Subjects Section */
    .subject-selection-block { border: 1px solid #dfe6e9; padding: 20px; border-radius: 8px; margin-bottom: 25px; background: white; }
    .block-header { background: #ecf0f1; padding: 10px; font-weight: bold; color: #2c3e50; border-radius: 4px; margin-bottom: 15px; }
    .subject-controls { display: grid; grid-template-columns: 1fr 1fr 1fr 100px; gap: 15px; margin-bottom: 15px; align-items: end; }
    .select-all-container { background: #f1f8ff; padding: 8px 12px; border: 1px solid #e1e5eb; display: flex; align-items: center; gap: 10px; }
    .subject-list { max-height: 300px; overflow-y: auto; border: 1px solid #e1e5eb; margin-bottom: 15px; background: #fff; }
    .subject-item { display: flex; align-items: center; padding: 10px 15px; border-bottom: 1px solid #f0f0f0; gap: 15px; }
    .subject-item input { width: 18px; height: 18px; margin: 0; cursor: pointer; flex-shrink: 0; }
    .subject-code { font-family: monospace; font-weight: bold; color: #8e44ad; width: 90px; flex-shrink: 0; }
    .subject-name { font-weight: 500; color: #2c3e50; font-size: 13px; }

    /* Results & Projects */
    .result-section, .project-details-section { background: #fdfdfd; padding: 15px; border: 1px solid #e0e0e0; border-radius: 6px; }
    .result-input-group { display: flex; flex-wrap: wrap; gap: 10px; align-items: end; margin-bottom: 10px; }
    .result-input-wrapper { flex: 1; min-width: 80px; }
    .proj-row-1 { display: grid; grid-template-columns: 100px 1fr 1fr; gap: 10px; margin-bottom: 10px; }
    .proj-row-students { display: grid; grid-template-columns: 120px 1fr 80px; gap: 10px; margin-bottom: 5px; }
    .added-results-list { margin-top: 10px; }
    .added-result-item { background: #f8f9fa; padding: 10px; border-left: 3px solid #2ecc71; margin-bottom: 5px; font-size: 13px; display: flex; justify-content: space-between; align-items: center; }

    /* Photo Sidebar */
    .photo-sidebar { position: fixed; top: 180px; right: 30px; width: 280px; background: white; padding: 20px; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); text-align: center; z-index: 100; color: #333; }
    #faculty-photo { width: 100%; max-height: 250px; object-fit: contain; border: 1px solid #eee; border-radius: 4px; margin-bottom: 10px; display: none; }

    /* Controls */
    .controls { display: flex; gap: 15px; margin: 40px auto; width: 100%; max-width: 1000px; justify-content: center; padding-bottom: 50px; flex-wrap: wrap; }
    .button { padding: 15px 20px; border: none; border-radius: 5px; color: white; font-weight: bold; cursor: pointer; font-size: 15px; flex: 1; max-width: 220px; text-align: center; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .button.save { background: #27ae60; }
    .button.preview { background: #f39c12; }
    .button.generate { background: #2980b9; }
    .button.upload { background: #8e44ad; }
    .button.upload:hover { background: #732d91; }
    .button.clear { background: #c0392b; }
    /* DISABLED STATE for Upload Button */
    .button:disabled { background: #95a5a6; cursor: not-allowed; opacity: 0.6; }

    /* Modal */
    .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(3px); }
    .modal-content { background-color: #fefefe; margin: 3% auto; border: 1px solid #888; width: 85%; max-width: 900px; border-radius: 8px; }
    .modal-header { background: #2c3e50; padding: 15px; color: white; display: flex; justify-content: space-between; border-radius: 8px 8px 0 0; }
    .preview-body { padding: 40px; background: white; color: #000; font-family: 'Times New Roman', serif; max-height: 80vh; overflow-y: auto; }

    /* PDF Sim */
    .pdf-header { text-align: center; font-weight: bold; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
    .pdf-section-title { font-size: 13px; font-weight: bold; margin-top: 15px; text-transform: uppercase; border-bottom: 1px solid #ccc; }
    .pdf-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 11px; }
    .pdf-table th, .pdf-table td { border: 1px solid #000; padding: 6px; text-align: left; vertical-align: top; }
    .pdf-table th { background-color: #f0f0f0; }
    .pdf-photo-box { float: right; width: 100px; height: 120px; border: 1px solid #000; margin-left: 15px; display: flex; justify-content: center; align-items: center; overflow: hidden; }
    .pdf-photo-box img { width: 100%; height: 100%; object-fit: cover; }
    .clearfix::after { content: ""; clear: both; display: table; }

    @media (max-width: 1200px) { .container { margin-right: 20px; } .photo-sidebar { position: static; width: 100%; margin: 0 0 20px 0; } .controls { flex-direction: column; } .pub-grid, .edu-spec-row, .edu-basics-row { grid-template-columns: 1fr; } .subject-controls { grid-template-columns: 1fr 1fr; } }
</style>

<canvas id="matrix-canvas"></canvas>

<!-- Navigation Tabs Only (Removed header-branding) -->
<div class="nav-tabs-container">
    <a href="{% url 'dashboard:dashboard' %}" class="nav-link-tab">Dashboard</a>
    <a href="{% url 'dashboard:faculty' %}" class="nav-link-tab active">Faculty</a>
    <a href="{% url 'dashboard:syllabus' %}" class="nav-link-tab">Syllabus</a>
    <a href="{% url 'dashboard:students' %}" class="nav-link-tab">Students</a>
    <a href="{% url 'dashboard:exambranch' %}" class="nav-link-tab">Exam Branch</a>
    <a href="{% url 'dashboard:laboratory' %}" class="nav-link-tab">Laboratory</a>
    <a href="{% url 'dashboard:gallery' %}" class="nav-link-tab">Gallery</a>
    <a href="{% url 'dashboard:logout' %}" class="nav-link-tab" style="border-color: #f00; color: #f00;">Logout</a>
</div>

<div class="main-wrapper">
    <form id="faculty-form" onsubmit="return false;">
    {% csrf_token %}

    <div class="container">
        <h1>Faculty Details Entry</h1>

        <div class="form-section">
            <h3>Basic Information</h3>
            <div class="form-grid">
                <div><label class="form-label">Employee Code</label><input type="text" id="employee-code" name="employee_code" placeholder="e.g. 7001" required></div>
                <div><label class="form-label">Name of Staff</label><input type="text" id="staff-name" placeholder="Full Name"></div>
                <div><label class="form-label">Department</label><input type="text" id="department" placeholder="Department"></div>
                <div><label class="form-label">Date of Joining</label><input type="date" id="joining-date"></div>
                <div><label class="form-label">Father Name</label><input type="text" id="father-name" placeholder="Father Name"></div>
            </div>
        </div>

        <div class="form-section">
            <h3>Personal Details</h3>
            <div class="form-grid">
                <div><label class="form-label">JNTUH ID</label><input type="text" id="jntuh-id"></div>
                <div><label class="form-label">AICTE ID</label><input type="text" id="aacte-id"></div>
                <div><label class="form-label">PAN</label><input type="text" id="pan"></div>
                <div><label class="form-label">AADHAR No</label><input type="text" id="aadhar"></div>
                <div><label class="form-label">ORCID ID</label><input type="text" id="orcid-id" maxlength="19" placeholder="0000-0000-0000-0000"></div>
                <div><label class="form-label">APAAR ID</label><input type="text" id="apaar-id" maxlength="15" placeholder="000-000-000-000"></div>
                <div><label class="form-label">Mobile No</label><input type="tel" id="mobile"></div>
                <div><label class="form-label">Mail ID</label><input type="email" id="email"></div>
                <div><label class="form-label">Gender</label><select id="gender"><option>Male</option><option>Female</option></select></div>
                <div><label class="form-label">DOB</label><input type="date" id="dob"></div>
                <div><label class="form-label">State</label><input type="text" id="state"></div>
                <div><label class="form-label">Caste</label><input type="text" id="caste"></div>
                <div><label class="form-label">Sub-Caste</label><input type="text" id="sub-caste"></div>
            </div>
        </div>

        <div class="form-section">
            <h3>Educational Qualifications</h3>
            <div class="edu-basics-row"><label class="form-label">SSC</label><input type="text" id="ssc-school" placeholder="School"><input type="text" id="ssc-year" placeholder="Year"><input type="text" id="ssc-percent" placeholder="%"><button type="button" class="mini-upload-btn" id="ssc-up-btn">Upload</button><input type="file" id="ssc-file" hidden accept="image/*,.pdf"></div>
            <div class="edu-basics-row"><label class="form-label">Inter</label><input type="text" id="inter-college" placeholder="College"><input type="text" id="inter-year" placeholder="Year"><input type="text" id="inter-percent" placeholder="%"><button type="button" class="mini-upload-btn" id="inter-up-btn">Upload</button><input type="file" id="inter-file" hidden accept="image/*,.pdf"></div>
            <div class="edu-header">UG (B.TECH)</div>
            <div class="edu-spec-row"><label>B.Tech</label><input type="text" id="ug-college" placeholder="College"><input type="text" id="ug-year" placeholder="Year"><input type="text" id="ug-percentage" placeholder="%"><input type="text" id="ug-spec" placeholder="Spec"><button type="button" class="mini-upload-btn" id="ug-up-btn">Upload</button><input type="file" id="ug-file" hidden accept="image/*,.pdf"></div>
            <div class="edu-header">PG (M.TECH)</div>
            <div class="edu-spec-row"><label>M.Tech</label><input type="text" id="pg-college" placeholder="College"><input type="text" id="pg-year" placeholder="Year"><input type="text" id="pg-percentage" placeholder="%"><input type="text" id="pg-spec" placeholder="Spec"><button type="button" class="mini-upload-btn" id="pg-up-btn">Upload</button><input type="file" id="pg-file" hidden accept="image/*,.pdf"></div>
            <div class="edu-header">Ph.D</div>
            <div class="edu-spec-row"><label>Ph.D</label><input type="text" id="phd-university" placeholder="Univ"><input type="text" id="phd-year" placeholder="Year"><select id="phd-degree"><option>Awarded</option><option>Pursuing</option></select><input type="text" id="phd-spec" placeholder="Spec"><button type="button" class="mini-upload-btn" id="phd-up-btn">Upload</button><input type="file" id="phd-file" hidden accept="image/*,.pdf"></div>
        </div>

        <div class="form-section">
            <h3>Experience & Address</h3>
            <div class="form-grid">
                <div><label class="form-label">Exp in Anurag</label><input type="text" id="exp-anurag" placeholder="Auto-calculated" readonly style="background:#e9ecef"></div>
                <div><label class="form-label">Exp Other</label><input type="text" id="exp-other"></div>
                <div style="grid-column: 1/-1"><label class="form-label">Address</label><input type="text" id="address"></div>
            </div>
        </div>

        <div class="form-section">
            <h3>Faculty Membership Details</h3>
            <div class="mem-grid">
                <div><label class="form-label">Details</label><input type="text" id="mem-text" placeholder="Name & ID"></div>
                <div><label class="form-label">Upload</label><div class="upload-box"><button type="button" id="mem-browse-btn" class="load-btn">Browse</button><input type="file" id="mem-file-input" hidden></div><button type="button" id="add-mem-btn" class="add-btn" style="width:100%; margin-top:15px;">ADD</button></div>
            </div>
            <div class="added-results-list" id="added-mem-container"></div>
        </div>

        <div class="form-section">
            <h3>Selection Committee Member (SCM)</h3>
            <div class="scm-grid">
                <div><label class="form-label">Details</label><input type="text" id="scm-text" placeholder="Details..."></div>
                <div><label class="form-label">Upload</label><div class="upload-box"><button type="button" id="scm-browse-btn" class="load-btn">Browse</button><input type="file" id="scm-file-input" hidden></div><button type="button" id="add-scm-btn" class="add-btn" style="width:100%; margin-top:15px;">ADD</button></div>
            </div>
            <div class="added-results-list" id="added-scm-container"></div>
        </div>

        <div class="form-section">
            <h3>Faculty Achievements</h3>
            <div class="achievements-grid">
                <div><label class="form-label">Description:</label><textarea id="achievements-text" rows="5"></textarea></div>
                <div><div class="date-row"><input type="date" id="ach-from-date"><input type="date" id="ach-to-date"></div><div class="upload-box"><button type="button" id="ach-browse-btn" class="load-btn">Browse</button><input type="file" id="ach-file-input" hidden></div><button type="button" id="add-ach-btn" class="add-btn" style="width:100%; margin-top:15px;">ADD</button></div>
            </div>
            <div class="added-results-list" id="added-achievements-container"></div>
        </div>

        <div class="form-section">
            <h3>Publications</h3>
            <div class="pub-grid">
                <div><label class="form-label">Type</label><select id="pub-type"><option>Journal</option><option>Conference</option><option>Book</option><option>Patent</option></select></div>
                <div class="pub-full"><label class="form-label">Title</label><input type="text" id="pub-title"></div>
                <div class="pub-full"><label class="form-label">Authors</label><input type="text" id="pub-authors"></div>
                <div><label class="form-label">Source</label><input type="text" id="pub-source"></div>
                <div><label class="form-label">Year</label><input type="date" id="pub-date"></div>
                <div><label class="form-label">DOI</label><input type="text" id="pub-doi"></div>
                <div><label class="form-label">Upload</label><div class="upload-box"><button type="button" id="pub-browse-btn" class="load-btn">Browse</button><input type="file" id="pub-file-input" hidden></div></div>
                <div><button type="button" id="add-pub-btn" class="add-btn" style="width:100%; margin-top:23px;">ADD</button></div>
            </div>
            <div class="added-results-list" id="added-pub-container"></div>
        </div>

        <div class="form-section">
            <h3>Subjects Dealt & Results (4 Slots)</h3>
            {% for i in "1234" %}
            <div class="subject-selection-block">
                <div class="block-header">Slot {{ i }}</div>
                <div class="subject-controls">
                    <div><label>AY</label><select id="select-academic-year-{{ i }}"><option>2022-2023</option><option>2023-2024</option><option>2024-2025</option><option>2025-2026</option></select></div>
                    <div><label>Year</label><select id="select-year-{{ i }}"><option value="First Year">First Year</option><option value="Second Year">Second Year</option><option value="Third Year">Third Year</option><option value="Fourth Year">Fourth Year</option></select></div>
                    <div><label>Sem</label><select id="select-semester-{{ i }}"><option>1-1</option><option>1-2</option><option>2-1</option><option>2-2</option><option>3-1</option><option>3-2</option><option>4-1</option><option>4-2</option></select></div>
                    <button type="button" class="load-btn" id="load-btn-{{ i }}">Load Subjects</button>
                </div>

                <div class="select-all-container"><input type="checkbox" id="select-all-{{ i }}"><label for="select-all-{{ i }}">Select All</label></div>
                <div class="subject-list" id="subjects-container-{{ i }}"></div>

                <div class="result-section">
                    <div class="result-input-group">
                        <div class="result-input-wrapper" style="flex:2"><label>Subject</label><input type="text" id="res-subject-{{ i }}"></div>
                        <div class="result-input-wrapper"><label>Classes</label><input type="number" id="res-classes-{{ i }}"></div>
                        <div class="result-input-wrapper"><label>App</label><input type="number" id="res-appeared-{{ i }}"></div>
                        <div class="result-input-wrapper"><label>Pass</label><input type="number" id="res-passed-{{ i }}"></div>
                        <div class="result-input-wrapper"><label>Fail</label><input type="number" id="res-failed-{{ i }}"></div>
                        <div class="result-input-wrapper"><label>%</label><input type="text" id="res-percentage-{{ i }}" readonly></div>
                        <button type="button" class="add-btn" id="btn-add-result-{{ i }}">+</button>
                    </div>
                    <div class="added-results-list" id="added-results-container-{{ i }}"></div>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="form-section">
            <h3>Projects Handled (4 Slots)</h3>
            {% for i in "1234" %}
            <div class="subject-selection-block">
                <div class="block-header">Project Slot {{ i }}</div>
                <div class="subject-controls">
                    <div><label>AY</label><select id="proj-academic-year-{{ i }}"><option>2022-2023</option><option>2023-2024</option><option>2024-2025</option><option>2025-2026</option></select></div>
                    <div style="flex:2"><label>Subject</label>
                        <select id="proj-subject-{{ i }}">
                            <option value="">-- Select --</option>
                            <option>2-2: IT409PW - Real-time Research Project</option>
                            <option>3-2: CS606PW - Internship/Mini Project</option>
                            <option>4-1: IT705PC - Project Stage I</option>
                            <option>4-2: IT802PC - Project Stage II</option>
                        </select>
                    </div>
                </div>
                <div class="project-details-section">
                    <div class="proj-row-1">
                        <div class="result-input-wrapper"><label>Batch</label><input type="text" id="proj-batch-{{ i }}"></div>
                        <div class="result-input-wrapper"><label>Title</label><input type="text" id="proj-title-{{ i }}"></div>
                        <div class="result-input-wrapper"><label>Supervisor</label><input type="text" id="proj-supervisor-{{ i }}"></div>
                    </div>
                    {% for k in "1234" %}
                    <div class="proj-row-students">
                        <div class="result-input-wrapper"><label>Roll {{ k }}</label><input type="text" id="proj-roll{{ k }}-{{ i }}"></div>
                        <div class="result-input-wrapper"><label>Name {{ k }}</label><input type="text" id="proj-stud{{ k }}-{{ i }}"></div>
                        <div class="result-input-wrapper"><label>Marks</label><input type="number" id="proj-marks{{ k }}-{{ i }}"></div>
                    </div>
                    {% endfor %}
                    <button type="button" class="add-btn" id="btn-add-proj-batch-{{ i }}" style="margin-top:10px;">ADD BATCH</button>
                    <div class="added-results-list" id="added-projects-container-{{ i }}"></div>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="form-section">
            <h3>About Yourself</h3>
            <textarea id="about-yourself" rows="5"></textarea>
        </div>
    </div>

    <div class="controls">
        <button type="button" class="button save" id="save-details-btn"><i class="fas fa-save"></i> Save</button>
        <button type="button" class="button preview" id="preview-details-btn"><i class="fas fa-eye"></i> Preview</button>
        <button type="button" class="button generate" id="generate-pdf-btn"><i class="fas fa-file-pdf"></i> Generate PDF</button>
        <button type="button" class="button upload" id="upload-pdf-btn" onclick="uploadPDF()" disabled><i class="fas fa-cloud-upload-alt"></i> Upload to Cloud</button>
        <button type="button" class="button clear" id="clear-all-btn"><i class="fas fa-trash"></i> Clear</button>
    </div>

    <aside class="photo-sidebar">
        <h3>Photo</h3>
        <div class="photo-preview-container"><img id="faculty-photo" src="" alt="Preview"><p id="no-photo-message">No photo</p></div>
        <div class="upload-controls"><button type="button" id="choose-file-btn" class="load-btn">Upload Photo</button><input type="file" id="photo-upload-input" style="display:none;"></div>
    </aside>

    <div id="preview-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>PREVIEW</h2><span class="close-modal">&times;</span></div>
            <div id="preview-content" class="preview-body"></div>
        </div>
    </div>

    </form> </div>

<script>
    /* Matrix Background Logic for consistent UI */
    const matrixCanvas = document.getElementById('matrix-canvas');
    const ctx = matrixCanvas.getContext('2d');
    matrixCanvas.width = window.innerWidth;
    matrixCanvas.height = window.innerHeight;

    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789@#$%^&*';
    const fontSize = 16;
    const columns = matrixCanvas.width / fontSize;
    const drops = Array(Math.floor(columns)).fill(1);

    function drawMatrix() {
        ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
        ctx.fillRect(0, 0, matrixCanvas.width, matrixCanvas.height);
        ctx.fillStyle = '#0f0';
        ctx.font = fontSize + 'px monospace';
        for (let i = 0; i < drops.length; i++) {
            const text = chars[Math.floor(Math.random() * chars.length)];
            ctx.fillText(text, i * fontSize, drops[i] * fontSize);
            if (drops[i] * fontSize > matrixCanvas.height && Math.random() > 0.975) drops[i] = 0;
            drops[i]++;
        }
    }
    setInterval(drawMatrix, 33);

    // --- CSRF HELPER ---
    function getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
    }

    const itSubjects = {
        "First Year": { "1-1": [{"code":"MA101BS","name":"MATRICES AND CALCULUS"},{"code":"AP102BS","name":"APPLIED PHYSICS"},{"code":"CS103ES","name":"PROGRAMMING FOR PROBLEM SOLVING"},{"code":"EN104HS","name":"ENGLISH FOR SKILL ENHANCEMENT"},{"code:"ME105ES","name":"ENGINEERING WORKSHOP"},{"code":"CS106ES","name":"ELEMENTS OF COMPUTER SCIENCE & ENGINEERING"},{"code":"AP107BS","name":"APPLIED PHYSICS LABORATORY"},{"code":"EN108HS","name":"ENGLISH LANGUAGE AND COMMUNICATION SKILLS LABORATORY"},{"code":"CS109ES","name":"PROGRAMMING FOR PROBLEM SOLVING LABORATORY"},{"code":"ES110MC","name":"ENVIRONMENTAL SCIENCE"}],"1-2":[{"code":"MA201BS","name":"ORDINARY DIFFERENTIAL EQUATIONS AND VECTOR CALCULUS"},{"code":"CH202BS","name":"ENGINEERING CHEMISTRY"},{"code":"EG203ES","name":"COMPUTER AIDED ENGINEERING GRAPHICS"},{"code":"EE204ES","name":"BASIC ELECTRICAL ENGINEERING"},{"code":"EC205ES","name":"ELECTRONIC DEVICES AND CIRCUITS"},{"code":"CH206BS","name":"ENGINEERING CHEMISTRY LABORATORY"},{"code":"CS207ES","name":"PYTHON PROGRAMMING LABORATORY"},{"code":"EE208ES","name":"BASIC ELECTRICAL ENGINEERING LABORATORY"},{"code":"CS209ES","name":"IT WORKSHOP"},{"code":"HS210MC","name":"CONSTITUTION OF INDIA"}] },
        "Second Year": { "2-1": [{"code":"PS301BS","name":"PROBABILITY AND STATISTICS"},{"code":"EC302ES","name":"DIGITAL ELECTRONICS"},{"code":"CS303PC","name":"DATA STRUCTURES"},{"code":"CM304PC","name":"COMPUTER ORGANIZATION AND MICROPROCESSOR"},{"code":"IT305PC","name":"INTRODUCTION TO IOT"},{"code":"CS306PC","name":"DATA STRUCTURES LABORATORY"},{"code":"EC307ES","name":"DIGITAL ELECTRONICS LABORATORY"},{"code":"IT308PC","name":"INTERNET OF THINGS LABORATORY"},{"code":"HS309MC","name":"GENDER SENSITIZATION"},{"code":"CS308PC","name":"SKILL DEVELOPMENT COURSE(DATA VISUALIZATION-R PROGRAMMING / POWER BI)"}],"2-2":[{"code":"MB401HS","name":"BUSINESS ECONOMICS & FINANCIAL ANALYSIS"},{"code":"CS402PC","name":"DISCRETE MATHEMATICS"},{"code":"CS403PC","name":"OPERATING SYSTEMS"},{"code":"CS404PC","name":"DATABASE MANAGEMENT SYSTEMS"},{"code":"IT405PC","name":"JAVA PROGRAMMING"},{"code":"CS406PC","name":"OPERATING SYSTEMS LABORATORY"},{"code":"CS407PC","name":"DATABASE MANAGEMENT SYSTEMS LABORATORY"},{"code":"IT408PC","name":"JAVA PROGRAMMING LABORATORY"},{"code":"IT409PW","name":"REAL-TIME RESEARCH PROJECT/ SOCIETAL RELATED PROJECT"},{"code":"IT410PC","name":"SKILL DEVELOPMENT COURSE (NODE JS/REACTJS/DJANGO)"},{"code":"HS411MC","name":"INTELLECTUAL PROPERTY RIGHTS"}] },
        "Third Year": { "3-1": [{"code":"CS501PC","name":"DESIGN AND ANALYSIS OF ALGORITHMS"},{"code":"IT502PC","name":"AUTOMATA AND COMPILER DESIGN"},{"code":"IT503PC","name":"EMBEDDED SYSTEMS"},{"code":"IT511PE","name":"FULL STACK DEVELOPMENT"},{"code":"IT512PE","name":"DATA MINING"},{"code":"CS513PE","name":"SCRIPTING LANGUAGES"},{"code":"IT514PE","name":"MOBILE APPLICATION DEVELOPMENT"},{"code":"IT515PE","name":"SOFTWARE TESTING METHODOLOGIES"},{"code":"AM515PE","name":"COMPUTER GRAPHICS"},{"code":"IT522PE","name":"QUANTUM COMPUTING"},{"code":"IT523PE","name":"ADVANCED OPERATING SYSTEMS"},{"code":"CS524PE","name":"DISTRIBUTED DATABASES"},{"code":"IT525PE","name":"PATTERN RECOGNITION"},{"code":"IT532PE","name":"DATA MINING LABORATORY"},{"code":"IT531PE","name":"FULL STACK DEVELOPMENT LABORATORY"},{"code":"IT533PE","name":"SCRIPTING LANGUAGES LABORATORY"},{"code":"IT534PE","name":"MOBILE APPLICATION DEVELOPMENT LABORATORY"},{"code":"IT535PE","name":"SOFTWARE TESTING METHODOLOGIES LABORATORY"},{"code":"IT504PC","name":"COMPILER DESIGN LABORATORY"},{"code":"IT505PC","name":"EMBEDDED SYSTEMS LABORATORY"},{"code":"CS507PC","name":"SKILL DEVELOPMENT COURSE(UI DESIGN FLUTTER)"}],"3-2":[{"code":"CS601PC","name":"MACHINE LEARNING"},{"code":"IT602PC","name":"SOFTWARE ENGINEERING"},{"code":"IT603PC","name":"DATA COMMUNICATIONS AND COMPUTER NETWORKS"},{"code":"IT611PE","name":"BIOMETRICS"},{"code":"IT612PE","name":"ADVANCED COMPUTER ARCHITECTURE"},{"code":"CS633PE","name":"DATA ANALYTICS"},{"code":"CS616PE","name":"IMAGE PROCESSING"},{"code":"CS617PE","name":"PRINCIPLES OF PROGRAMMING LANGUAGES"},{"code":"CE611OE","name":"DISASTER PREPAREDNESS & PLANNING MANAGEMENT"},{"code":"CE612OE","name":"BUILDING MANAGEMENT SYSTEMS"},{"code":"CE613OE","name":"ENVIRONMENTAL IMPACT ASSESSMENT"},{"code":"CE614OE","name":"HYDROGEOLOGY"},{"code":"EE611OE","name":"RENEWABLE ENERGY SOURCES"},{"code":"EE612OE","name":"FUNDAMENTAL OF ELECTRIC VEHICLES"},{"code":"ME611OE","name":"BASIC MECHANICAL ENGINEERING"},{"code":"ME612OE","name":"POWER PLANT ENGINEERING"},{"code":"EC611OE","name":"FUNDAMENTALS OF INTERNET OF THINGS"},{"code":"EC612OE","name":"PRINCIPLES OF SIGNAL PROCESSING"},{"code":"EC613OE","name":"DIGITAL ELECTRONICS FOR ENGINEERING"},{"code":"CS611OE","name":"DATA STRUCTURES"},{"code":"CS612OE","name":"DATABASE MANAGEMENT SYSTEMS"},{"code":"IT611OE","name":"JAVA PROGRAMMING"},{"code":"IT612OE","name":"SOFTWARE ENGINEERING"},{"code":"AM611OE","name":"FUNDAMENTALS OF AI"},{"code":"AM612OE","name":"MACHINE LEARNING BASICS"},{"code":"CS604PC","name":"MACHINE LEARNING LABORATORY"},{"code":"IT605PC","name":"SOFTWARE ENGINEERING & COMPUTER NETWORKS LABORATORY"},{"code":"AE606HS","name":"ADVANCED ENGLISH COMMUNICATION SKILLS LABORATORY"},{"code":"CS606PW","name":"INDUSTRIAL ORIENTED MINI PROJECT/ INTERNSHIP/ SKILL DEVELOPMENT COURSE (BIG DATA SPARK)"},{"code":"ES607MC","name":"ENVIRONMENTAL SCIENCE"}] },
        "Fourth Year": { "4-1": [{"code":"IT701PC","name":"INFORMATION SECURITY"},{"code":"IT702PC","name":"CLOUD COMPUTING"},{"code":"IT711PE","name":"HUMAN COMPUTER INTERACTION"},{"code":"IT712PE","name":"HIGH PERFORMANCE COMPUTING"},{"code":"IT713PE","name":"ARTIFICIAL INTELLIGENCE"},{"code":"IT714PE","name":"INFORMATION RETRIEVAL SYSTEMS"},{"code":"IT715PE","name":"AD-HOC & SENSOR NETWORKS"},{"code":"IT721PE","name":"NATURAL LANGUAGE PROCESSING"},{"code":"IT722PE","name":"DISTRIBUTED SYSTEMS"},{"code":"IT723PE","name":"AUGMENTED REALITY & VIRTUAL REALITY"},{"code":"IT724PE","name":"WEB SECURITY"},{"code":"IT725PE","name":"CYBER FORENSICS"},{"code":"CE721OE","name":"REMOTE SENSING & GEOGRAPHICAL INFORMATION SYSTEMS"},{"code":"CE722OE","name":"SUSTAINABLE INFRASTRUCTURE DEVELOPMENT"},{"code":"CE723OE","name":"SOLID WASTE MANAGEMENT"},{"code":"CE724OE","name":"SMART CITIES"},{"code":"EE721OE","name":"UTILIZATION OF ELECTRIC ENERGY"},{"code":"EE722OE","name":"ENERGY STORAGE SYSTEMS"},{"code":"ME721OE","name":"QUANTITATIVE ANALYSIS FOR BUSINESS DECISIONS"},{"code":"ME722OE","name":"INDUSTRIAL ENGINEERING & MANAGEMENT"},{"code":"EC721OE","name":"ELECTRONIC SENSORS"},{"code":"EC722OE","name":"ELECTRONICS FOR HEALTH CARE"},{"code":"EC723OE","name":"TELECOMMUNICATIONS FOR SOCIETY"},{"code":"CS721OE","name":"OPERATING SYSTEMS"},{"code":"CS722OE","name":"COMPUTER NETWORKS"},{"code":"IT721OE","name":"FULL STACK DEVELOPMENT"},{"code":"IT722OE","name":"SCRIPTING LANGUAGES"},{"code":"AM721OE","name":"INTRODUCTION TO NATURAL LANGUAGE PROCESSING"},{"code":"AM722OE","name":"AI APPLICATIONS"},{"code":"IT703PC","name":"INFORMATION SECURITY LAB"},{"code":"IT704PC","name":"CLOUD COMPUTING LAB"},{"code":"IT705PC","name":"PROJECT STAGE â€“ I"}],"4-2":[{"code":"IT801PC","name":"ORGANIZATIONAL BEHAVIOR"},{"code":"IT811PE","name":"INTRUSION DETECTION SYSTEMS"},{"code":"IT812PE","name":"REAL TIME SYSTEMS"},{"code":"IT813PE","name":"BLOCK CHAIN TECHNOLOGY"},{"code":"IT814PE","name":"DEEP LEARNING"},{"code":"IT815PE","name":"SOFTWARE PROCESS & PROJECT MANAGEMENT"},{"code":"CE831OE","name":"ENERGY EFFICIENT BUILDINGS"},{"code":"CE832OE","name":"MULTI CRITERION DECISION MAKING"},{"code":"CE833OE","name":"ENVIRONMENTAL POLLUTION"},{"code":"EE831OE","name":"CHARGING INFRASTRUCTURE FOR ELECTRIC VEHICLES"},{"code":"EE832OE","name":"RELIABILITY ENGINEERING"},{"code":"ME831OE","name":"ELEMENTS OF ELECTRIC AND HYBRID VEHICLES"},{"code":"ME832OE","name":"ENTREPRENEURSHIP DEVELOPMENT"},{"code":"EC831OE","name":"MEASURING INSTRUMENTS"},{"code":"EC832OE","name":"COMMUNICATION TECHNOLOGIES"},{"code":"EC833OE","name":"FUNDAMENTALS OF SOCIAL NETWORKS"},{"code":"CS831OE","name":"DESIGN AND ANALYSIS OF ALGORITHMS"},{"code":"CS832OE","name":"DATA ANALYTICS"},{"code":"IT831OE","name":"BIG DATA TECHNOLOGIES"},{"code":"IT832OE","name":"DEVOPS"},{"code":"AM831OE","name":"CHATBOTS"},{"code":"AM832OE","name":"EVOLUTIONARY COMPUTING"},{"code":"IT802PC","name":"PROJECT STAGE-II, INCLUDING SEMINAR"}] }
    };

    let uploaded = { achievements:[], scm:[], pubs:[], edu:{ssc:null, inter:null, ug:null, pg:null, phd:null}, mem:[] };
    let savedData = null;
    const fmtDate = (d) => d ? d.split('-').reverse().join('-') : '';

    // --- 2. SHARED PDF GENERATION FUNCTION ---
    async function generateFinalPDFBlob() {
        if(!savedData) { alert("Save details first!"); return null; }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Header
        doc.setFontSize(16); doc.text("ANURAG ENGINEERING COLLEGE", 105, 15, {align:'center'});
        doc.setFontSize(12); doc.text("FACULTY DIRECTORY", 105, 22, {align:'center'});
        doc.setLineWidth(0.5); doc.line(10, 25, 200, 25);

        const img = document.getElementById('faculty-photo');
        if(img.src.startsWith('data:')) try{ doc.addImage(img.src,'JPEG',150,30,35,45); }catch(e){}

        // Basic Info
        doc.autoTable({startY: 35, tableWidth: 140, theme:'plain', body:[
            ['Code', savedData.basic.code], ['Name', savedData.basic.name],
            ['Dept', savedData.basic.dept], ['Joined', savedData.basic.joined]
        ]});
        let y = Math.max(80, doc.lastAutoTable.finalY + 10);

        // Personal
        doc.text("PERSONAL DETAILS", 14, y); y+=5;
        doc.autoTable({startY: y, theme:'grid', body:[
           ['JNTUH ID', savedData.personal.jntuh, 'AICTE ID', savedData.personal.aicte],
           ['PAN', savedData.personal.pan, 'AADHAR', savedData.personal.aadhar],
           ['MOBILE', savedData.personal.mobile, 'EMAIL', savedData.personal.email],
           ['ORCID', savedData.personal.orcid, 'APAAR', savedData.personal.apaar],
           ['DOB', savedData.personal.dob, 'STATE', savedData.personal.state],
           ['CASTE', savedData.personal.caste, 'SUB-CASTE', savedData.personal.subcaste]
        ]});
        y = doc.lastAutoTable.finalY + 10;

        // Education
        doc.text("EDUCATIONAL QUALIFICATIONS", 14, y); y+=5;
        doc.autoTable({startY: y, head:[['Degree','Year','%/CGPA','Specialization','Institute']], body: savedData.edu});
        y = doc.lastAutoTable.finalY + 10;

        // Subjects
        doc.text("SUBJECTS DEALT & RESULTS", 14, y); y+=5;
        let subs = [];
        for(let i=1; i<=4; i++) {
            const s = Array.from(document.querySelectorAll(`#subjects-container-${i} .subject-checkbox:checked`)).map(c=>c.nextElementSibling.nextElementSibling.innerText).join('\n');
            const r = Array.from(document.querySelectorAll(`#added-results-container-${i} .added-result-item`)).map(d=>d.dataset.txt).join('\n\n');
            const p = Array.from(document.querySelectorAll(`#added-results-container-${i} .added-result-item`)).map(d=>d.dataset.pct).join('\n\n');
            if(s||r) subs.push([document.getElementById(`select-academic-year-${i}`).value, s, r, p]);
        }
        doc.autoTable({startY: y, head:[['Year','Subject','Stats', 'Pass %']], body: subs});
        y = doc.lastAutoTable.finalY + 10;

        // Projects
        doc.addPage(); y=20;
        doc.text("PROJECTS HANDLED", 14, y); y+=5;
        let projRows = [];
        document.querySelectorAll('[id^=added-projects] .added-result-item').forEach(p => {
            if(p.dataset.students) projRows.push([p.dataset.title, p.dataset.batch, p.dataset.students, p.dataset.marks]);
        });
        doc.autoTable({startY: y, head:[['Title','Batch','Students','Marks']], body: projRows});
        y = doc.lastAutoTable.finalY + 10;

        // Achievements
        doc.text("FACULTY ACHIEVEMENTS", 14, y); y+=5;
        doc.autoTable({startY: y, head:[['Description','Duration']], body: savedData.ach});
        y = doc.lastAutoTable.finalY + 10;

        // About (Last)
        doc.text("ABOUT FACULTY", 14, y); y+=7;
        doc.setFontSize(10);
        doc.text(doc.splitTextToSize(savedData.about, 180), 14, y);

        // Merge
        const pdfBytes = doc.output('arraybuffer');
        const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
        const allFiles = [
            uploaded.edu.ssc, uploaded.edu.inter, uploaded.edu.ug, uploaded.edu.pg, uploaded.edu.phd,
            ...uploaded.mem, ...uploaded.scm, ...uploaded.pubs, ...uploaded.achievements
        ];

        for(const f of allFiles) {
            if(!f) continue;
            try {
                const b = await f.arrayBuffer();
                if(f.type === 'application/pdf') {
                    const c = await PDFLib.PDFDocument.load(b);
                    (await pdfDoc.copyPages(c, c.getPageIndices())).forEach(p => pdfDoc.addPage(p));
                } else if(f.type.startsWith('image/')) {
                    const i = f.type==='image/png'?await pdfDoc.embedPng(b):await pdfDoc.embedJpg(b);
                    const p = pdfDoc.addPage();
                    p.drawImage(i, {x:20, y:20, width:170, height:250});
                }
            } catch(e){}
        }
        return new Blob([await pdfDoc.save()], {type:'application/pdf'});
    }

    // --- UPLOAD FUNCTION ---
    async function uploadPDF() {
        if (!savedData) {
            alert("Please save details before uploading");
            return;
        }

        // Generate PDF
        const pdfBlob = await generateFinalPDFBlob();
        if (!pdfBlob) {
            alert("PDF generation failed");
            return;
        }

        const formData = new FormData();
        // ðŸ”¥ Key MUST be "pdf"
        const empCode = document.getElementById("employee-code").value.trim();
        if (!empCode) {
            alert("Employee Code is required for upload");
            return;
        }
        formData.append("pdf", pdfBlob, `${empCode}.pdf`);
        formData.append("employee_code", empCode);

        fetch("/upload-generated-pdf/", {
            method: "POST",
            headers: {
                "X-CSRFToken": getCSRFToken() // Add CSRF token header
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "success") {
                alert("Upload successful");
                console.log("Cloudinary URL:", data.url);
            } else {
                alert("Upload failed: " + data.error);
            }
        })
        .catch(error => {
            console.error("Upload error:", error);
            alert("Upload error");
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        // --- 1. HELPERS & UPLOADS ---
        const bindFile = (btn, inp, cb) => {
            const btnEl = document.getElementById(btn);
            const inpEl = document.getElementById(inp);
            if(btnEl && inpEl) {
                btnEl.onclick = (e) => { e.preventDefault(); inpEl.click(); };
                inpEl.onchange = function() { cb(this.files[0]); };
            }
        };

        bindFile('choose-file-btn', 'photo-upload-input', (f) => {
            if(f) { const r = new FileReader(); r.onload=e=>{ document.getElementById('faculty-photo').src=e.target.result; document.getElementById('faculty-photo').style.display='block'; document.getElementById('no-photo-message').style.display='none'; }; r.readAsDataURL(f); }
        });
        ['ssc','inter','ug','pg','phd'].forEach(lvl => {
            bindFile(`${lvl}-up-btn`, `${lvl}-file`, (f) => { if(f) { uploaded.edu[lvl]=f; document.getElementById(`${lvl}-up-btn`).innerText="Uploaded"; document.getElementById(`${lvl}-up-btn`).style.background="#27ae60"; } });
        });
        ['scm','ach','pub','mem'].forEach(t => {
            bindFile(`${t}-browse-btn`, `${t}-file-input`, (f) => {
                 // Note: corrected from snippet to include element check if needed
            });
        });

        // --- 2. LIST MGMT ---
        const addListItem = (id, html, file, arr) => {
            if(file) arr.push(file);
            document.getElementById(id).insertAdjacentHTML('beforeend', `<div class="added-result-item">${html}</div>`);
        };

        document.getElementById('add-scm-btn').onclick = (e) => { e.preventDefault(); const t = document.getElementById('scm-text').value; if(t) addListItem('added-scm-container', `<b>${t}</b>`, document.getElementById('scm-file-input').files[0], uploaded.scm); document.getElementById('scm-text').value=''; };
        document.getElementById('add-mem-btn').onclick = (e) => { e.preventDefault(); const t = document.getElementById('mem-text').value; if(t) addListItem('added-mem-container', `<b>${t}</b>`, document.getElementById('mem-file-input').files[0], uploaded.mem); document.getElementById('mem-text').value=''; };
        document.getElementById('add-ach-btn').onclick = (e) => {
            e.preventDefault();
            const d = document.getElementById('achievements-text').value;
            const r = `${fmtDate(document.getElementById('ach-from-date').value)} to ${fmtDate(document.getElementById('ach-to-date').value)}`;
            if(d) {
                const f = document.getElementById('ach-file-input').files[0];
                if(f) uploaded.achievements.push(f);
                document.getElementById('added-achievements-container').insertAdjacentHTML('beforeend', `<div class="added-result-item" data-desc="${d}" data-range="${r}"><b>${d}</b> <small>(${r})</small></div>`);
            }
            document.getElementById('achievements-text').value='';
        };
        document.getElementById('add-pub-btn').onclick = (e) => {
            e.preventDefault();
            const t = document.getElementById('pub-title').value;
            if(t) addListItem('added-pub-container', `<b>[${document.getElementById('pub-type').value}] ${t}</b> (${fmtDate(document.getElementById('pub-date').value)})`, document.getElementById('pub-file-input').files[0], uploaded.pubs);
            document.getElementById('pub-title').value='';
        };

        // --- 3. EXP CALC ---
        const calcExp = () => {
            const val = document.getElementById('joining-date').value;
            if(!val) return;
            const d1 = new Date(val), d2 = new Date();
            let y=d2.getFullYear()-d1.getFullYear(), m=d2.getMonth()-d1.getMonth(), d=d2.getDate()-d1.getDate();
            if(d<0){ m--; d+=new Date(d2.getFullYear(),d2.getMonth(),0).getDate(); }
            if(m<0){ y--; m+=12; }
            document.getElementById('exp-anurag').value = `${y}Y ${m}M ${d}D`;
        };
        document.getElementById('joining-date').onchange = calcExp;
        document.getElementById('joining-date').oninput = calcExp;

        // --- 4. SLOTS ---
        for(let i=1; i<=4; i++) {
             document.getElementById(`load-btn-${i}`).onclick = (e) => {
                 e.preventDefault();
                 const c = document.getElementById(`subjects-container-${i}`);
                 c.innerHTML = '';
                 const y = document.getElementById(`select-year-${i}`).value, s = document.getElementById(`select-semester-${i}`).value;
                 (itSubjects[y]?.[s]||[]).forEach(sub => c.insertAdjacentHTML('beforeend', `<div class="subject-item"><input type="checkbox" class="subject-checkbox" checked> <span class="subject-code">${sub.code}</span> <span class="subject-name">${sub.name}</span></div>`));
             };
             document.getElementById(`select-all-${i}`).onchange = (e) => {
                 document.querySelectorAll(`#subjects-container-${i} .subject-checkbox`).forEach(cb => cb.checked = e.target.checked);
             };

             const calc = () => {
                 const a = parseFloat(document.getElementById(`res-appeared-${i}`).value)||0;
                 const p = parseFloat(document.getElementById(`res-passed-${i}`).value)||0;
                 document.getElementById(`res-failed-${i}`).value = (a>=p)?(a-p):0;
                 document.getElementById(`res-percentage-${i}`).value = a>0 ? ((p/a)*100).toFixed(2)+'%' : '0.00%';
             };
             document.getElementById(`res-appeared-${i}`).oninput = calc;
             document.getElementById(`res-passed-${i}`).oninput = calc;

             document.getElementById(`btn-add-result-${i}`).onclick = (e) => {
                 e.preventDefault();
                 const s = document.getElementById(`res-subject-${i}`).value;
                 if(s) document.getElementById(`added-results-container-${i}`).insertAdjacentHTML('beforeend', `<div class="added-result-item" data-txt="App:${document.getElementById(`res-appeared-${i}`).value}, Pass:${document.getElementById(`res-passed-${i}`).value}, Fail:${document.getElementById(`res-failed-${i}`).value}" data-pct="${document.getElementById(`res-percentage-${i}`).value}"><b>${s}</b>: ${document.getElementById(`res-percentage-${i}`).value}</div>`);
             };

             document.getElementById(`btn-add-proj-batch-${i}`).onclick = (e) => {
                 e.preventDefault();
                 const t = document.getElementById(`proj-title-${i}`).value;
                 let students = [], marks = [];
                 for(let k=1; k<=4; k++) {
                     let n = document.getElementById(`proj-stud${k}-${i}`).value, r = document.getElementById(`proj-roll${k}-{{ i }}`).value, m = document.getElementById(`proj-marks${k}-{{ i }}`).value;
                     if(n || r) { students.push(`${n} (${r})`); marks.push(m || '-'); }
                 }
                 if(t) {
                     const div = document.createElement('div');
                     div.className = 'added-result-item';
                     div.dataset.title = t;
                     div.dataset.batch = document.getElementById(`proj-batch-${i}`).value;
                     div.dataset.students = students.join('\n');
                     div.dataset.marks = marks.join('\n');
                     div.innerHTML = `<b>${t}</b> (${div.dataset.batch})<br><small>${students.join(', ')}</small>`;
                     document.getElementById(`added-projects-container-${i}`).appendChild(div);
                 }
             };
        }

        // --- 5. SAVE & PREVIEW ---
        document.getElementById('save-details-btn').onclick = (e) => {
            e.preventDefault();
            savedData = {
                basic: { name: document.getElementById('staff-name').value, code: document.getElementById('employee-code').value, dept: document.getElementById('department').value, joined: fmtDate(document.getElementById('joining-date').value) },
                personal: { jntuh: document.getElementById('jntuh-id').value, aicte: document.getElementById('aacte-id').value, pan: document.getElementById('pan').value, aadhar: document.getElementById('aadhar').value, mobile: document.getElementById('mobile').value, email: document.getElementById('email').value, orcid: document.getElementById('orcid-id').value, apaar: document.getElementById('apaar-id').value, dob: fmtDate(document.getElementById('dob').value), state: document.getElementById('state').value, caste: document.getElementById('caste').value, subcaste: document.getElementById('sub-caste').value },
                edu: [
                    ['SSC', document.getElementById('ssc-year').value, document.getElementById('ssc-percent').value, '-', document.getElementById('ssc-school').value],
                    ['Inter', document.getElementById('inter-year').value, document.getElementById('inter-percent').value, '-', document.getElementById('inter-college').value],
                    ['UG', document.getElementById('ug-year').value, document.getElementById('ug-percentage').value, document.getElementById('ug-spec').value, document.getElementById('ug-college').value],
                    ['PG', document.getElementById('pg-year').value, document.getElementById('pg-percentage').value, document.getElementById('pg-spec').value, document.getElementById('pg-college').value],
                    ['PhD', document.getElementById('phd-year').value, '-', document.getElementById('phd-spec').value, document.getElementById('phd-university').value]
                ],
                ach: Array.from(document.querySelectorAll('#added-achievements-container .added-result-item')).map(a => [a.dataset.desc, a.dataset.range]),
                about: document.getElementById('about-yourself').value
            };

            // Validate Employee Code
            const empCode = document.getElementById("employee-code").value.trim();
            if (!empCode) {
                alert("Employee Code is required before upload");
                return;
            }

            // Enable upload button
            document.getElementById("upload-pdf-btn").disabled = false;

            alert("Details Saved!");
        };

        const modal = document.getElementById('preview-modal');
        document.querySelector('.close-modal').onclick = () => modal.style.display = "none";
        document.getElementById('preview-details-btn').onclick = (e) => {
            e.preventDefault();
            if(!savedData) return alert("Save first!");
            const img = document.getElementById('faculty-photo').src;
            const photoHtml = img.startsWith('data:') ? `<div class="pdf-photo-box"><img src="${img}"></div>` : '';
            document.getElementById('preview-content').innerHTML = `
                <div class="clearfix">
                    ${photoHtml}
                    <div class="pdf-header"><div class="pdf-title">ANURAG ENGINEERING COLLEGE</div><div class="pdf-subtitle">FACULTY DIRECTORY</div></div>
                    <div class="pdf-section-title">Basic Info</div>
                    <table class="pdf-table"><tr><th>Code</th><td>${savedData.basic.code}</td><th>Name</th><td>${savedData.basic.name}</td></tr><tr><th>Dept</th><td>${savedData.basic.dept}</td><th>Joined</th><td>${savedData.basic.joined}</td></tr></table>
                    <div class="pdf-section-title">Personal Details</div>
                    <table class="pdf-table"><tr><th>Mobile</th><td>${savedData.personal.mobile}</td><th>Email</th><td>${savedData.personal.email}</td></tr></table>
                    <div class="pdf-section-title">Education</div>
                    <table class="pdf-table"><tr><th>Level</th><th>Year</th><th>%</th><th>Spec</th><th>Institute</th></tr>${savedData.edu.map(r=>`<tr><td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td><td>${r[4]}</td></tr>`).join('')}</table>
                    <div class="pdf-section-title">Achievements</div><ul>${savedData.ach.map(a => `<li>${a[0]} (${a[1]})</li>`).join('')}</ul>
                    <div class="pdf-section-title">About</div><div>${savedData.about}</div>
                </div>`;
            modal.style.display = "block";
        };

        // --- 7. DOWNLOAD ---
        document.getElementById('generate-pdf-btn').onclick = async (e) => {
            e.preventDefault();

            const empIdInput = document.getElementById("employee-code");
            const empId = (empIdInput && empIdInput.value.trim()) ? empIdInput.value.trim() : 'Faculty_Report';

            const blob = await generateFinalPDFBlob();
            if(blob) {
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `${empId}.pdf`;
                link.click();
            }
        };

        document.getElementById('clear-all-btn').onclick = () => location.reload();
    });
</script>
{% endblock %}